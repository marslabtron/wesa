!function(t){"use strict";void 0===t.wesa&&(t.wesa=function(){const t={fromTranslation:function(t){let e=new Float32Array(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e},ortho:function(t,e,i,o,n,r){let s=new Float32Array(16),a=1/(t-e),l=1/(i-o),c=1/(n-r);return s[0]=-2*a,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*l,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*c,s[11]=0,s[12]=(t+e)*a,s[13]=(o+i)*l,s[14]=(r+n)*c,s[15]=1,s}};function e(t,e,i){const o=t.createShader(e);return t.shaderSource(o,i),t.compileShader(o),t.getShaderParameter(o,t.COMPILE_STATUS)?o:(console.error("WESA Core: An error occurred compiling the shaders: "+t.getShaderInfoLog(o)),t.deleteShader(o),null)}const i={source:{spriteSheetUrlArray:[],objectJsonUrl:null},spriteSheetList:[],objectList:[],load:function(t){let e=this;if(0==e.source.spriteSheetUrlArray.length)return void console.error("WESA Loader: No sprite sheet added.");if(!e.source.objectJsonUrl)return void console.error("WESA Loader: No object added.");let i=0,o=!1;var r=[],c=null;let h=e.source.spriteSheetUrlArray;function u(u){if("image"==u?i++:(u="object")&&(o=!0),i==h.length&&o){let i=JSON.parse(c);for(let t=0;t<i.spriteSheetsMeta.length;t++){let o=i.spriteSheetsMeta[t],a=new s({ssid:t,rowCount:o.rowCount,colCount:o.colCount,cellWidth:o.cellWidth,cellHeight:o.cellHeight});a.loadTextureFromImage(n.handle.gl,r[t]),e.spriteSheetList.push(a)}for(let t=0;t<i.objects.length;t++){let o=i.objects[t],n=new wesa.StoredObject({oid:t,type:o.type,name:o.name}),r=n.frameList;for(let t=0;t<o.frameList.length;t++){let i=o.frameList[t];if("array"==i.loadMode)for(let t=0;t<i.cells.rowCount*i.cells.colCount;t++){let o=i.idStart+t;if(r[o])console.error('wesaAssets.load(): WESAFrame conflicts on WESAObject "'+n.name+'". Frame #"'+o+'".');else{let n=i.cells.rowStart+Math.floor(t/i.cells.colCount),s=i.cells.colStart+t%i.cells.colCount;r[o]=new a({spriteSheet:e.spriteSheetList[i.spriteSheet],cell:{row:n,col:s,rowSpan:1,colSpan:1},center:{x:i.center.x,y:i.center.y}})}}else"single"==i.loadMode?r[i.id]?console.error('wesaAssets.load(): WESAFrame conflicts on WESAObject "'+n.name+'". Frame #"'+i.id+'".'):r[i.id]=new a({spriteSheet:e.spriteSheetList[i.spriteSheet],cell:{row:i.cell.row,col:i.cell.col,rowSpan:i.cell.rowSpan,colSpan:i.cell.colSpan},center:{x:i.center.x,y:i.center.y}}):console.error('wesaAssets.load(): Missing frame loading mode when loading frames for "'+n.name+'". Got "'+i.loadMode+'".')}for(let t=0;t<o.animList.length;t++){let e=o.animList[t],i=new l({aid:t,name:e.name,next:e.hasOwnProperty("next")?e.next:t});e.hasOwnProperty("collision")?(i.collision.hit=e.collision.hasOwnProperty("hit")?e.collision.hit:null,i.collision.hurt=e.collision.hasOwnProperty("hurt")?e.collision.hurt:null):o.hasOwnProperty("defaultCollision")&&(i.collision.hit=o.defaultCollision.hasOwnProperty("hit")?o.defaultCollision.hit:null,i.collision.hurt=o.defaultCollision.hasOwnProperty("hurt")?o.defaultCollision.hurt:null),i.setFrames(Array.from(e.frameList,t=>null==t?null:r[t]),e.frameTimeList.slice()),n.addAnimation(t,i)}e.objectList.push(n)}t()}}for(let t=0;t<h.length;t++)r[t]=new Image,r[t].src=h[t],r[t].onload=function(){u("image")},r[t].onerror=function(){console.warning('WESA Loader: Image "'+urlArray[t]+'" load failed.'),u("image")};let d=new XMLHttpRequest;d.open("GET",this.source.objectJsonUrl),d.onload=function(){d.status>=200&&d.status<400?(c=d.responseText,u("object")):console.error('WESA Loader: Cannot load JSON "'+this.source.objectJsonUrl+'".')},d.onerror=function(){console.error('WESA Loader: Cannot load JSON "'+this.source.objectJsonUrl+'" (connection error).')},d.send()}},o={fps:0,collisionChecks:0,collisionsDetected:0},n={handle:{gl:null,shader:null,buffer:null},config:{shaderSource:{vs:"\n                        attribute vec4 aVertexPosition;\n                        attribute vec2 aTextureCoord;\n                        uniform mat4 uModelViewMatrix;\n                        uniform mat4 uProjectionMatrix;\n                        varying highp vec2 vTextureCoord;\n                        void main() {\n                            gl_Position = uProjectionMatrix * uModelViewMatrix * aVertexPosition;\n                            vTextureCoord = aTextureCoord;\n                        }\n                    ",fs:"\n                        varying highp vec2 vTextureCoord;\n                        uniform sampler2D uSampler;\n                        void main(void) {\n                            gl_FragColor = texture2D(uSampler, vTextureCoord);\n                        }\n                    "}},canvasResize:function(){let e=this.handle.gl,i=this.handle.shader,o=-e.canvas.width/2,n=e.canvas.width/2,r=-e.canvas.height/2,s=e.canvas.height/2,a=t.ortho(o,n,r,s,.1,100);e.uniformMatrix4fv(i.uniformLocations.projectionMatrix,!1,a),e.viewport(0,0,e.canvas.width,e.canvas.height)},init:function(i){if(!i||"CANVAS"!=i.tagName)return void console.error("WESA Core: Canvas provided is invalid.");const o=i.getContext("webgl");if(!o)return void console.error("WESA Core: Unable to initialize WebGL. Your browser or machine may not support it.");const n=function(t,i,o){const n=e(t,t.VERTEX_SHADER,i),r=e(t,t.FRAGMENT_SHADER,o),s=t.createProgram();return t.attachShader(s,n),t.attachShader(s,r),t.linkProgram(s),t.getProgramParameter(s,t.LINK_STATUS)?s:(console.error("WESA Core: Unable to initialize the shader program: "+t.getshaderProgramInfoLog(s)),null)}(o,this.config.shaderSource.vs,this.config.shaderSource.fs),r={program:n,attribLocations:{vertexPosition:o.getAttribLocation(n,"aVertexPosition"),textureCoord:o.getAttribLocation(n,"aTextureCoord")},uniformLocations:{projectionMatrix:o.getUniformLocation(n,"uProjectionMatrix"),modelViewMatrix:o.getUniformLocation(n,"uModelViewMatrix"),uSampler:o.getUniformLocation(n,"uSampler")}},s={positions:o.createBuffer(),texCoords:o.createBuffer(),indices:o.createBuffer()};!function(e,i){e.clearColor(0,0,0,1),e.clearDepth(1),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.useProgram(i.program);let o=-e.canvas.width/2,n=e.canvas.width/2,r=-e.canvas.height/2,s=e.canvas.height/2,a=t.ortho(o,n,r,s,.1,100);e.uniformMatrix4fv(i.uniformLocations.projectionMatrix,!1,a);let l=t.fromTranslation([0,0,-6]);e.uniformMatrix4fv(i.uniformLocations.modelViewMatrix,!1,l),e.activeTexture(e.TEXTURE0),e.uniform1i(i.uniformLocations.uSampler,0),e.enableVertexAttribArray(i.attribLocations.vertexPosition),e.enableVertexAttribArray(i.attribLocations.textureCoord)}(o,r),this.handle.gl=o,this.handle.shader=r,this.handle.buffer=s}},r={position:{x:0,y:0},zoom:1};function s(t){this.ssid=t.ssid,this.rowCount=t.rowCount,this.colCount=t.colCount,this.cellWidth=t.cellWidth,this.cellHeight=t.cellHeight,this.texture=null}function a(t){this.spriteSheet=t.spriteSheet,this.cell={row:t.cell.row,col:t.cell.col,rowSpan:t.cell.rowSpan,colSpan:t.cell.colSpan},this.center={x:t.center.x,y:t.center.y},this.collision={hit:null,hurt:null},this.width=t.spriteSheet.cellWidth*t.cell.colSpan,this.height=t.spriteSheet.cellHeight*t.cell.rowSpan}function l(t){this.aid=t.aid,this.name=t.name,this.next=t.next,this.frameList=[],this.endTimeList=[],this.collision={hit:null,hurt:null}}function c(t){this.oid=t.oid,this.type=t.type,this.name=t.name,this.frameList=[],this.animList=[]}function h(t){this.object=t.object,this.action=t.action,this.team=t.team,this.position={x:t.position.x,y:t.position.y},this.scale="number"==typeof t.scale?{x:t.scale,y:t.scale}:{x:t.scale.x,y:t.scale.y},this.prevPosition={x:0,y:0},this.aiList=[],this.velocity={x:0,y:0},this.acceleration={x:0,y:0},this.scene=null,this.frameNum=0,this.state=0,this.time=0,this.deadFlag=!1,this.delayedActionChange=null,this.collision={mode:h.CollisionMode.BY_SPRITE,hit:null,hurt:null}}function u(){this.self=null,this.target=null,this.execute=null}function d(t){this.lid=t.lid,this.spriteList=[],this.batchData=null}function p(t){this.name=t,this.layerList=[]}return s.prototype.loadTextureFromImage=function(t,e){this.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE)},s.prototype.getCellCount=function(){return this.rowCount*this.colCount},s.prototype.getTextureClipByIndex=function(t){var e={},i=1/this.colCount,o=1/this.rowCount;return e.x1=i*(t%this.colCount),e.x2=e.x1+i*cellCount,e.y1=o*Math.floor(t/this.colCount),e.y2=e.y1+o,e},s.prototype.getTextureClipByPosition=function(t,e,i=1,o=1){var n={},r=1/this.colCount,s=1/this.rowCount;return n.x1=r*e,n.x2=n.x1+r*o,n.y1=s*t,n.y2=n.y1+s*i,n},l.prototype.setFrames=function(t,e){var i=t.length,o=0;this.frameList=t.slice();for(let t=0;t<i;t++)o+=e[t],this.endTimeList[t]=o},c.prototype.addAnimation=function(t,e){this.animList[t]=e},c.prototype.addAnimationByArray=function(t){this.animList=t.slice()},h.CollisionMode=Object.freeze({BY_SPRITE:"BY_SPRITE",BY_ANIMATION:"BY_ANIMATION",BY_FRAME:"BY_FRAME"}),h.CollisionShape=Object.freeze({CIRCLE:"CIRCLE",RECT:"RECT"}),h.prototype.getCurrentAnim=function(){return this.object.animList[this.action]},h.prototype.getCurrentFrame=function(){return this.object.animList[this.action].frameList[this.frameNum]},h.prototype.changeAction=function(t,e){e.isSmart&&this.action==t||(e.isImmediate?(this.action=t,this.time=0,this.frameNum=0):this.delayedActionChange=t)},h.prototype.setTime=function(t){let e=this.object.animList[this.action].endTimeList,i=e[e.length-1];t<0&&(t=0),t>=i&&(t=i-1),this.time=t;for(let i=0;i<e.length;i++)if(t<e[i]){this.frameNum=i;break}},h.prototype.addAI=function(t){t.self=this,this.aiList.push(t)},h.prototype.addAIWithExecFunc=function(t){if("function"!=typeof t)return void console.error('WESASprite: Parameter of addAIWithExecFunc() must be function. Object: "'+this.object.name+'"');let e=new u;e.execute=t,e.self=this,this.aiList.push(e)},h.prototype.kill=function(){this.deadFlag=!0},h.prototype.update=function(){for(let t=0;t<this.aiList.length;t++)this.aiList[t].execute();let t=this.object.animList[this.action];if(!t)return void console.error("WESASprite: No animation for action #"+this.action+'. Object: "'+this.object.name+'"');let e=t.frameList.length;this.time++,this.time>=t.endTimeList[this.frameNum]&&(this.frameNum++,this.time>=t.endTimeList[e-1]&&(this.time=0),this.frameNum>=e&&(this.frameNum=0,null!=t.next?t.next!=this.action&&this.changeAction(t.next,{isSmart:!1,isImmediate:!0}):this.kill())),this.prevPosition.x=this.position.x,this.prevPosition.y=this.position.y,this.position.x+=this.velocity.x,this.position.y+=this.velocity.y,this.velocity.x+=this.acceleration.x,this.velocity.y+=this.acceleration.y,this.delayedActionChange&&(this.changeAction(this.delayedActionChange,{isSmart:!1,isImmediate:!0}),this.delayedActionChange=null)},d.prototype.addSprite=function(t){this.spriteList.push(t)},d.prototype.update=function(){let t=this.spriteList;for(let e=0;e<t.length;e++)t[e].deadFlag||t[e].update();for(let e=t.length-1;e>=0;e--)t[e].deadFlag&&t.splice(e,1)},d.prototype.render=function(t,e,o){this.batchData=[];for(let t=0;t<this.spriteList.length;t++)if(this.spriteList[t]){let e=this.spriteList[t],i=e.getCurrentFrame();if(i){let t,o,n,r,s,a=i.spriteSheet.ssid;if(!(e instanceof h))return void console.error("WESALayer: An error occurred when rendering: Unknown sprite type: "+e.constructor.name);if(o=(t=e.position.x-i.center.x*e.scale.x)+i.width*e.scale.x,r=(n=e.position.y-i.center.y*e.scale.y)+i.height*e.scale.y,s=i.spriteSheet.getTextureClipByPosition(i.cell.row,i.cell.col,i.cell.rowSpan,i.cell.colSpan),this.batchData[a]){this.batchData[a].spriteCount++;let e=4*(this.batchData[a].spriteCount-1);this.batchData[a].positions.push(t,n,o,n,t,r,o,r),this.batchData[a].texCoords.push(s.x1,s.y2,s.x2,s.y2,s.x1,s.y1,s.x2,s.y1),this.batchData[a].indices.push(e,e+1,e+2,e+1,e+2,e+3)}else this.batchData[a]={spriteCount:1,positions:[t,n,o,n,t,r,o,r],texCoords:[s.x1,s.y2,s.x2,s.y2,s.x1,s.y1,s.x2,s.y1],indices:[0,1,2,1,2,3]}}}for(let n=0;n<this.batchData.length;n++)this.batchData[n]&&(t.bindBuffer(t.ARRAY_BUFFER,o.positions),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.batchData[n].positions),t.STATIC_DRAW),t.vertexAttribPointer(e.attribLocations.vertexPosition,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,o.texCoords),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.batchData[n].texCoords),t.STATIC_DRAW),t.vertexAttribPointer(e.attribLocations.textureCoord,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,o.indices),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.batchData[n].indices),t.STATIC_DRAW),t.bindTexture(t.TEXTURE_2D,i.spriteSheetList[n].texture),t.drawElements(t.TRIANGLES,this.batchData[n].indices.length,t.UNSIGNED_SHORT,0))},p.prototype.addSpriteToLayer=function(t,e){if(!this.layerList[t]){var i=new d({lid:t});this.layerList[t]=i}this.layerList[t].addSprite(e),e.layer=this.layerList[t],e.scene=this},p.prototype.clear=function(){this.layerList=[]},p.prototype.getCollisions=function(t){let e=[];if(t.layerIndexes)for(let t=0;t<layerIndexes.length;t++)this.layerList[layerIndexes[t]]&&e.push(this.layerList[layerIndexes[t]].spriteList);else for(let t=0;t<this.layerList.length;t++)this.layerList[t]&&e.push(this.layerList[t].spriteList);let i=[].concat.apply([],e),n=[],r=0;for(let e=0;e<i.length;e++)for(let o=0;o<i.length;o++){if(e==o)continue;let s,a,l=i[e],c=i[o];if((!t.collisionMatrix||t.collisionMatrix[l.object.type][c.object.type])&&(l.collision.mode==h.CollisionMode.BY_SPRITE?s=l.collision.hit:l.collision.mode==h.CollisionMode.BY_ANIMATION?s=l.getCurrentAnim().collision.hit:(l.collision.mode,h.CollisionMode.BY_FRAME),c.collision.mode==h.CollisionMode.BY_SPRITE?a=c.collision.hurt:c.collision.mode==h.CollisionMode.BY_ANIMATION?a=c.getCurrentAnim().collision.hurt:(c.collision.mode,h.CollisionMode.BY_FRAME),s&&a)){let t={shape:s.shape},e={shape:a.shape};if(t.shape==h.CollisionShape.CIRCLE?(t.center={x:l.position.x+s.centerRelative.x,y:l.position.y+s.centerRelative.y},t.radius=s.radius):t.shape==h.CollisionShape.RECT&&(t.x1=l.position.x+s.x1Relative,t.x2=l.position.x+s.x2Relative,t.y1=l.position.y+s.y1Relative,t.y2=l.position.y+s.y2Relative),e.shape==h.CollisionShape.CIRCLE?(e.center={x:c.position.x+a.centerRelative.x,y:c.position.y+a.centerRelative.y},e.radius=a.radius):e.shape==h.CollisionShape.RECT&&(e.x1=c.position.x+a.x1Relative,e.x2=c.position.x+a.x2Relative,e.y1=c.position.y+a.y1Relative,e.y2=c.position.y+a.y2Relative),t.shape==h.CollisionShape.CIRCLE&&e.shape==h.CollisionShape.CIRCLE){let i=t.center.x,o=e.center.x,r=t.center.y,s=e.center.y,a=i-o,h=r-s,u=Math.sqrt(a*a+h*h),d=t.radius,p=e.radius;d+p>u&&n.push({hitter:l,hurter:c,collisionPoint:{x:(p*p*i+d*d*o)/(d*d+p*p),y:(p*p*r+d*d*s)/(d*d+p*p)}})}else if(t.shape==h.CollisionShape.CIRCLE&&e.shape==h.CollisionShape.RECT){let i,o,r=0,s=0;t.center.x<e.x1?(r=e.x1-t.center.x,i=e.x1):t.center.x>e.x2?(r=t.center.x-e.x2,i=e.x2):i=t.center.x,t.center.y<e.y1?(s=e.y1-t.center.y,o=e.y1):t.center.y>e.y2?(s=t.center.y-e.y2,o=e.y2):o=t.center.y;let a=Math.sqrt(r*r+s*s);t.radius>a&&n.push({hitter:l,hurter:c,collisionPoint:{x:i,y:o}})}else t.shape==h.CollisionShape.RECT&&e.shape==h.CollisionShape.CIRCLE||t.shape==h.CollisionShape.RECT&&e.shape==h.CollisionShape.RECT&&t.x1<=e.x2&&t.y1<=e.y2&&t.x2>=e.x1&&t.y2>=e.y1&&n.push({hitter:l,hurter:c,collisionPoint:{x:(t.x1+t.x2+e.x1+e.x2)/4,y:(t.y1+t.y2+e.y1+e.y2)/4}});r++}}return o.collisionChecks=r,o.collisionsDetected=n.length,n},p.prototype.update=function(){for(let t=0;t<this.layerList.length;t++)this.layerList[t]&&this.layerList[t].update()},p.prototype.render=function(){let e=n.handle.gl,i=n.handle.shader,o=n.handle.buffer;e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.uniformMatrix4fv(i.uniformLocations.modelViewMatrix,!1,t.fromTranslation([-r.position.x,-r.position.y,-6]));for(let t=0;t<this.layerList.length;t++)this.layerList[t]&&this.layerList[t].render(e,i,o)},{SpriteSheet:s,Frame:a,Animation:l,StoredObject:c,Sprite:h,AI:u,Scene:p,core:n,assets:i,camera:r,stat:o}}())}(window);